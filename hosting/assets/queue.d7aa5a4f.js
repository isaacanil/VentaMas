import{i as v}from"./inherits.c04b427a.js";import{e as y}from"./events.38b94b46.js";var m={exports:{}},b=v.exports,d=y.exports.EventEmitter;m.exports=s;m.exports.default=s;function s(t){if(!(this instanceof s))return new s(t);d.call(this),t=t||{},this.concurrency=t.concurrency||1/0,this.timeout=t.timeout||0,this.autostart=t.autostart||!1,this.results=t.results||null,this.pending=0,this.session=0,this.running=!1,this.jobs=[],this.timers={}}b(s,d);var j=["pop","shift","indexOf","lastIndexOf"];j.forEach(function(t){s.prototype[t]=function(){return Array.prototype[t].apply(this.jobs,arguments)}});s.prototype.slice=function(t,e){return this.jobs=this.jobs.slice(t,e),this};s.prototype.reverse=function(){return this.jobs.reverse(),this};var x=["push","unshift","splice"];x.forEach(function(t){s.prototype[t]=function(){var e=Array.prototype[t].apply(this.jobs,arguments);return this.autostart&&this.start(),e}});Object.defineProperty(s.prototype,"length",{get:function(){return this.pending+this.jobs.length}});s.prototype.start=function(t){if(t&&O.call(this,t),this.running=!0,this.pending>=this.concurrency)return;if(this.jobs.length===0){this.pending===0&&f.call(this);return}var e=this,i=this.jobs.shift(),u=!0,r=this.session,n=null,c=!1,l=null,p=i.hasOwnProperty("timeout")?i.timeout:this.timeout;function h(o,g){u&&e.session===r&&(u=!1,e.pending--,n!==null&&(delete e.timers[n],clearTimeout(n)),o?e.emit("error",o,i):c===!1&&(l!==null&&(e.results[l]=Array.prototype.slice.call(arguments,1)),e.emit("success",g,i)),e.session===r&&(e.pending===0&&e.jobs.length===0?f.call(e):e.running&&e.start()))}p&&(n=setTimeout(function(){c=!0,e.listeners("timeout").length>0?e.emit("timeout",h,i):h()},p),this.timers[n]=n),this.results&&(l=this.results.length,this.results[l]=null),this.pending++,e.emit("start",i);var a=i(h);a&&a.then&&typeof a.then=="function"&&a.then(function(o){return h(null,o)}).catch(function(o){return h(o||!0)}),this.running&&this.jobs.length>0&&this.start()};s.prototype.stop=function(){this.running=!1};s.prototype.end=function(t){E.call(this),this.jobs.length=0,this.pending=0,f.call(this,t)};function E(){for(var t in this.timers){var e=this.timers[t];delete this.timers[t],clearTimeout(e)}}function O(t){var e=this;this.on("error",i),this.on("end",u);function i(r){e.end(r)}function u(r){e.removeListener("error",i),e.removeListener("end",u),t(r,this.results)}}function f(t){this.session++,this.running=!1,this.emit("end",t)}export{m as q};
